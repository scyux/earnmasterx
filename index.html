<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Earn Master — Safe Auto Ads</title>
<style>
  /* Basit stil (orijinalin teması korunuyor) */
  body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);min-height:100vh;display:flex;align-items:center;justify-content:center;color:#fff}
  .card{background:rgba(20,20,20,0.9);padding:24px;border-radius:14px;width:380px;box-shadow:0 10px 30px rgba(0,0,0,.6);text-align:center}
  h1{font-family:Orbitron,Arial,sans-serif;color:#00ffcc;margin-bottom:8px}
  .stats p{margin:6px 0}
  .progress{width:100px;height:100px;border-radius:50%;margin:12px auto;display:flex;align-items:center;justify-content:center;font-weight:700;color:#00ffcc}
  .btn{width:100%;padding:10px;border-radius:10px;border:none;margin-top:8px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(45deg,#ff512f,#dd2476);color:#fff}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.08);color:#fff}
  #countdown{margin-top:10px;font-size:14px;color:#ffd;}
  .small{font-size:12px;color:#bbb;margin-top:8px}
  label{display:block;text-align:left;margin-top:8px;font-size:13px;color:#ccc}
  input[type=number]{width:100%;padding:8px;border-radius:8px;border:none;background:#111;color:#fff;margin-top:6px}
</style>
</head>
<body>
<div class="card">
  <h1>Earn Master</h1>
  <div class="stats">
    <p>Watched Ads: <span id="watched-ads">0</span></p>
    <p>Earned Points: <span id="earned-points">0.00</span></p>
  </div>
  <div class="progress" id="progress-circle"><span id="ads-progress">0%</span></div>

  <button id="watch-ad-btn" class="btn primary" disabled>Watch Ad</button>
  <button id="auto-ad-btn" class="btn primary">Start Auto Ads (15s)</button>
  <button id="stop-auto-btn" class="btn ghost" disabled>Stop Auto</button>

  <div id="countdown" style="display:none">Next ad in <span id="countdown-seconds">15</span>s …</div>
  <div class="small">
    <p>Session limit: <span id="session-limit">100</span> ads — güvenli kullanım için sınır koyulmuştur.</p>
    <p>Not: Auto Ads başlatmak için ilk önce "Start Auto Ads" butonuna tıklamanız gerekir (kullanıcı etkileşimi).</p>
  </div>
</div>

<!-- Monetag SDK (örnek) -->
<script src="https://libtl.com/sdk.js" data-zone="10175246" data-sdk="show_10175246"></script>

<script>
/*
  Güvenlik/anti-ban prensipleri:
  - Sahte tıklama/simülasyon yok.
  - SDK'nın onReward/onClose veya Promise sonuçları bekleniyor.
  - Reklamlar arası sabit 15s + küçük rastgele sapma.
  - Otomatik modda session başına limit.
  - Hata/backoff yönetimi.
*/

let watchedAdsCount = parseInt(localStorage.getItem('watchedAdsCount')) || 0;
let earnedPoints = parseFloat(localStorage.getItem('earnedPoints')) || 0;
let monetagLoaded = false;

const MAX_SESSION_ADS = 100;      // oturum başına güvenli limit (değiştirilebilir)
let sessionAds = 0;
let autoMode = false;
let stopRequested = false;

// UI elemanları
const watchBtn = document.getElementById('watch-ad-btn');
const autoBtn = document.getElementById('auto-ad-btn');
const stopBtn = document.getElementById('stop-auto-btn');
const watchedEl = document.getElementById('watched-ads');
const earnedEl = document.getElementById('earned-points');
const progressPctEl = document.getElementById('ads-progress');
const countdownWrap = document.getElementById('countdown');
const countdownSecondsEl = document.getElementById('countdown-seconds');
document.getElementById('session-limit').textContent = MAX_SESSION_ADS;

// Başlangıç veri gösterimi
function updateUI(){
  watchedEl.textContent = watchedAdsCount;
  earnedEl.textContent = earnedPoints.toFixed(2);
  const pct = Math.min(Math.round((watchedAdsCount/10)*100),100);
  progressPctEl.textContent = pct + '%';
}
updateUI();

// Monetag SDK hazır mı kontrol et (polling)
function checkSDK(){
  // SDK fonksiyon adını mevcut sayfada kontrol et
  if (typeof window.show_10175246 === 'function' || typeof window.show_10175246 !== 'undefined') {
    monetagLoaded = true;
    watchBtn.disabled = false;
    console.log('✅ Monetag SDK hazır.');
  } else {
    console.log('⏳ Monetag SDK bekleniyor...');
    setTimeout(checkSDK, 800);
  }
}
window.addEventListener('DOMContentLoaded', checkSDK);

// localStorage kaydet
function saveProgress(){
  localStorage.setItem('watchedAdsCount', watchedAdsCount);
  localStorage.setItem('earnedPoints', earnedPoints.toFixed(2));
  updateUI();
}

// SDK çağrı wrapper: callback veya Promise destekleyen SDK'larla çalışacak şekilde tasarlandı.
// Eğer SDK farklı event isimleri kullanıyorsa (ör: on_impression), SDK dokümantasyonuna göre uyarlayın.
function callShowAdWithCallbacks(timeoutMs = 30000){
  return new Promise((resolve, reject) => {
    if (!monetagLoaded) return reject(new Error('SDK not loaded'));

    let settled = false;
    function safeResolve(val){ if(!settled){ settled = true; resolve(val); } }
    function safeReject(err){ if(!settled){ settled = true; reject(err); } }

    try{
      // 1) Eğer SDK callback object destekliyorsa çağırmayı deneyelim
      try {
        const maybeReturn = show_10175246({
          onReward: () => {
            console.log('SDK onReward');
            safeResolve({event:'reward'});
          },
          onClose: () => {
            console.log('SDK onClose');
            safeResolve({event:'close'});
          },
          onError: (e) => {
            console.warn('SDK onError', e);
            safeReject(e || new Error('Ad error'));
          }
        });

        // 2) Eğer SDK Promise döndürdüyse onu da dinle
        if (maybeReturn && typeof maybeReturn.then === 'function') {
          maybeReturn.then((res) => {
            console.log('SDK Promise resolved', res);
            safeResolve({event:'promise', data:res});
          }).catch((e)=> safeReject(e));
        }
      } catch(cbErr){
        // Eğer yukarıdaki format çalışmazsa fallback (bazı SDK'lar doğrudan show() şeklinde olabilir)
        try {
          const maybePromise = show_10175246();
          if (maybePromise && typeof maybePromise.then === 'function') {
            maybePromise.then((res)=> safeResolve({event:'promise', data:res})).catch(safeReject);
          } else {
            // hiçbirşey dönmediyse, SDK muhtemelen global event atıyor — bekleyeceğiz; ama timeout koyuyoruz
            console.log('SDK çağrıldı, callback yok, fallback bekleniyor...');
          }
        } catch(innerErr){
          console.error('show_10175246 çağrısı başarısız', innerErr);
          safeReject(innerErr);
        }
      }

      // Her durumda bir timeout: eğer SDK bir event emit etmezse promise reject/resolve olacak
      const to = setTimeout(()=> {
        if (!settled) {
          console.warn('Ad callback timeout');
          safeReject(new Error('Ad callback timeout'));
        }
      }, timeoutMs);

      // cleanup: resolve/reject olduğunda timeout'u temizle
      const origResolve = resolve;
      const origReject = reject;
      // not altering them; safeResolve/safeReject temizliyor zaten

    } catch(err){
      safeReject(err);
    }
  });
}

// Tek bir reklam gösterimini yönet: başarılı ödül/close durumuna göre puan ekler.
// NOT: bazı ad network'ler onReward ile ödülü doğrular — burada onReward geldiğinde puan veriyoruz.
async function showAdAndHandle(){
  try {
    const res = await callShowAdWithCallbacks(35000); // 35s timeout
    // Eğer onReward geldi ise puan ver; onClose geldiyse yine kontrol edebiliriz.
    if (res && res.event === 'reward') {
      watchedAdsCount++;
      earnedPoints += 0.5;
      sessionAds++;
      saveProgress();
      console.log('Ad rewarded. Session ads:', sessionAds);
    } else if (res && (res.event === 'close' || res.event === 'promise')) {
      // Bazı SDK'larda onClose ile de reward verilmiş olabilir, veya ayrı event olabilir.
      // Burada güvenli davranış: eğer SDK ayrı onReward veriyorsa onu beklemek daha doğru.
      // Ama çoğu durumda onClose -> izleme tamamlandı.
      watchedAdsCount++;
      earnedPoints += 0.5;
      sessionAds++;
      saveProgress();
      console.log('Ad closed/promise resolved — counted as watched. Session ads:', sessionAds);
    } else {
      console.log('Ad finished with unknown event, not counting.');
    }
    return { ok:true };
  } catch (e) {
    console.warn('showAdAndHandle hata:', e);
    return { ok:false, error:e };
  }
}

// İnsan benzeri gecikleme: sabit 15s + küçük rastgele sapma (±1-3s)
function waitBetweenAds(baseSeconds = 15){
  const jitter = Math.floor(Math.random()*3000) - 1000; // -1000 .. +1999 ms (yaklaşık -1s..+2s)
  const totalMs = Math.max(5000, (baseSeconds*1000) + jitter); // min 5s güvenlik
  countdownWrap.style.display = 'block';
  let remaining = Math.round(totalMs/1000);
  countdownSecondsEl.textContent = remaining;
  return new Promise((resolve) => {
    const start = Date.now();
    const interval = setInterval(() => {
      const elapsed = Date.now() - start;
      remaining = Math.max(0, Math.ceil((totalMs - elapsed)/1000));
      countdownSecondsEl.textContent = remaining;
      if (elapsed >= totalMs) {
        clearInterval(interval);
        countdownWrap.style.display = 'none';
        resolve();
      }
    }, 250);
  });
}

// Auto loop — reklamlar arası mantık burada
async function autoAdsLoop(){
  stopRequested = false;
  while(autoMode && !stopRequested){
    // Güvenlik: session limiti
    if (sessionAds >= MAX_SESSION_ADS) {
      console.warn('Session ad limit reached.');
      alert('Session ad limit reached for safety. Stop Auto Ads.');
      stopAutoAds();
      break;
    }

    // 1) Show ad and handle reward/close
    const result = await showAdAndHandle();

    // 2) Hata durumunda backoff uygula
    if (!result.ok) {
      // basit exponential backoff (örnek)
      const backoffMs = 10000 + Math.floor(Math.random()*10000);
      console.warn('Ad error -> backoff', backoffMs);
      await new Promise(r => setTimeout(r, backoffMs));
      // hata sonrası devam edilebilir; döngü devam eder
    } else {
      // başarılıysa bekleme (15s + jitter)
      await waitBetweenAds(15);
    }

    // küçük rastgele bekleme (0.5 - 2s) daha doğal görünmesi için
    await new Promise(r => setTimeout(r, 500 + Math.floor(Math.random()*1500)));
  }
}

// Başlat/durdur fonksiyonları
function startAutoAds(){
  if (!monetagLoaded) return alert('Ad SDK yüklenmedi, lütfen bekleyin.');
  if (autoMode) return;
  autoMode = true;
  watchBtn.disabled = true;
  autoBtn.disabled = true;
  stopBtn.disabled = false;
  // İlk reklam çağrısı, kullanıcı zaten butona tıkladı sayılır (kullanıcı etkileşimi).
  autoAdsLoop().catch(e => console.error('Auto loop hata', e));
}

function stopAutoAds(){
  stopRequested = true;
  autoMode = false;
  watchBtn.disabled = false;
  autoBtn.disabled = false;
  stopBtn.disabled = true;
  countdownWrap.style.display = 'none';
}

// Tekil izleme butonu (manuel)
watchBtn.addEventListener('click', async () => {
  if (!monetagLoaded) return alert('Ad SDK henüz hazır değil.');
  const r = await showAdAndHandle();
  if (!r.ok) alert('Ad yüklenemedi veya hata oluştu.');
});

// otomatik başlat/durdur butonları
autoBtn.addEventListener('click', () => {
  // Kullanıcıya uyarı (yalnızca bilgilendirme): otomatik mod kontrolü
  const proceed = confirm('Auto Ads başlatılacak. Reklamlar arası 15 saniye bekleme yapılacaktır. Devam edilsin mi?');
  if (!proceed) return;
  startAutoAds();
});
stopBtn.addEventListener('click', stopAutoAds);

// sayfa kapanırken durdur
window.addEventListener('beforeunload', () => {
  stopRequested = true;
});

// başlangıç
checkSDK();
saveProgress();
</script>
</body>
</html>
